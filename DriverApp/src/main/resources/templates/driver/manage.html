<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{/include/headerbaseLayout}"/>
    <title>승하차관리페이지</title>
    <link rel="stylesheet" href="/css/driver/manage.css">
    <link rel="stylesheet" href="/css/child/childDetail.css">
    <script src="/js/driver/manage.js"></script>
    <script src="/js/driver/kakaoMap.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8997d782f5298e9e818dbcbf6a5ab396&libraries=services"></script>
</head>
<body>
<th:block th:replace="~{/include/baseLayout :: setContent(~{ :: .app-content})}">

    <section class="app-content">
        <div class="content-header">
            <div class="backBtn"><img src="/img/back.png" alt="뒤로가기"></div>
            <div class="header-comment-wrap">
                <p class="header-mainComment">승하차관리</p>
                <p class="header-subComment">동대문구 1노선</p>
            </div>
        </div>



        <!-- 카카오맵 스크립트 추가 -->
        <script type="text/javascript"
                src="//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakao.javascript.key}&libraries=services"></script>

        <!-- 지도 컨테이너 -->
        <div id="map" style="width:100%;height:250px;"></div>

        <!-- 경로 표시 스크립트 -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            document.addEventListener('DOMContentLoaded', function() {
                // 1. 지도 초기화
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780),
                    level: 5
                };
                const map = new kakao.maps.Map(mapContainer, mapOption);

                // 2. 기존 경로 지우기 위한 변수
                let currentPolyline = null;

                // 3. 경로 그리기 함수
                function drawRoute(startX, startY, endX, endY) {
                    fetch(`/api/map/route?startX=${startX}&startY=${startY}&endX=${endX}&endY=${endY}`)
                        .then(response => response.json())
                        .then(coordinates => {
                            // 기존 경로가 있으면 지우기
                            if (currentPolyline) {
                                currentPolyline.setMap(null);
                            }
                            const path = [];
                            for(let i=0; i<coordinates.length; i+=2) {
                                path.push(new kakao.maps.LatLng(coordinates[i+1], coordinates[i]));
                            }
                            currentPolyline = new kakao.maps.Polyline({
                                map: map,
                                path: path,
                                strokeWeight: 5,
                                strokeColor: '#FF00FF',
                                strokeOpacity: 0.7
                            });
                            const bounds = new kakao.maps.LatLngBounds();
                            path.forEach(coord => bounds.extend(coord));
                            map.setBounds(bounds);
                        })
                        .catch(error => {
                            alert('경로를 불러오는데 실패했습니다.');
                            console.error(error);
                        });
                }

                // 4. 주소 또는 장소명(POI)로 좌표 얻기
                function getCoords(input, callback) {
                    const geocoder = new kakao.maps.services.Geocoder();
                    geocoder.addressSearch(input, function(result, status) {
                        if (status === kakao.maps.services.Status.OK && result.length > 0) {
                            callback(result[0].x, result[0].y);
                        } else {
                            // 주소 변환 실패 → 장소명(POI) 검색 시도
                            const places = new kakao.maps.services.Places();
                            places.keywordSearch(input, function(result, status) {
                                if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                    callback(result[0].x, result[0].y);
                                } else {
                                    callback(null, null);
                                }
                            });
                        }
                    });
                }

                // 5. 버튼 클릭 시 처리
                document.getElementById('drawRouteBtn').addEventListener('click', function() {
                    const startAddress = document.getElementById('startAddress').value.trim();
                    const endAddress = document.getElementById('endAddress').value.trim();




                    if (!startAddress || !endAddress) {
                        alert('출발지와 도착지 주소 또는 역명을 모두 입력해주세요.');
                        return;
                    }

                    // 출발지 좌표 변환
                    getCoords(startAddress, function(startX, startY) {
                        if (startX && startY) {
                            // 도착지 좌표 변환
                            getCoords(endAddress, function(endX, endY) {
                                if (endX && endY) {
                                    drawRoute(startX, startY, endX, endY);
                                    console.log(startX+' '+startY);
                                    console.log(endX+' '+endY);
                                } else {
                                    alert('도착지 주소 또는 역명을 찾을 수 없습니다.');
                                }
                            });
                        } else {
                            alert('출발지 주소 또는 역명을 찾을 수 없습니다.');
                        }
                    });
                });

                // 6. 페이지 로드시 기본 경로 자동 표시 (원하면 지워도 됨)
                drawRoute(127.03041938929663, 37.50133927181133, 127.030515949937, 37.4996237314472);
            });
            /*]]>*/
        </script>
        출발지 도착지 입력

        <div style="margin-bottom:10px;">
            <input type="text" id="startAddress" placeholder="출발지 주소 입력" style="width:200px;"><br>
            <input type="text" id="endAddress" placeholder="도착지 주소 입력" style="width:200px;">
            <button id="drawRouteBtn">경로 그리기</button>
        </div>



        <!--승하차관련-->
        <div class="boarding-status"></div>
        <div class="list-card" th:each="child : ${childrenList}"
                               th:data-child-name="${child.childName}"
                               th:data-parent-name="${child.userVO.userName}"
                               th:data-address="${child.userVO.userAddress+' '+child.userVO.userAddressDetail}"
                               th:data-kinder-name="${child.kinderVO.kinderName}"
                               th:data-parent-phone="${child.userVO.userPhone}"
                               th:data-child-gender="${child.childGender}">
            <div class="list-box">
                <div class="list-img">
                    <img src="/img/child.png" alt="아이사진">
                </div>
                <div class="list-content">
                    <div th:text="${child.childName}">이름(나이)</div>
                    <div th:text="${child.userVO.userAddress+' '+child.userVO.userAddressDetail}">주소</div>
<!--                    <div th:text="'하차 시간 ' + (${child.dropoffTime} ?: '')">하차 시간 &#45;&#45;:&#45;&#45; </div>-->
                </div>
                <div th:class="'list-time' + (${child.dropState} == '하차완료' ? ' done' : '')"
                     th:text="${child.dropState} == '하차완료' ? '하차완료' : '하차'">하차</div>
            </div>

        </div>
        <div class="addModal modal">
            <div class="modal-content">
                <th:block th:replace="~{/child/childDetail}"></th:block>
            </div>
        </div>

        <div class>

        </div>


    </section>
</th:block>
</body>
</html>